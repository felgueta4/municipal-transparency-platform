generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/municipal_transparency_platform/frontend/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT CORE MODEL
// ============================================

model Tenant {
  id                   String    @id @default(cuid())
  slug                 String    @unique // Para subdominios: renca.transparenciaciudadana.com
  name                 String    // Nombre de la municipalidad
  status               String    @default("active") // active, suspended, provisioning
  plan                 String    @default("base") // base, pro, enterprise
  
  // Localización
  country              String    @default("Chile")
  region               String
  comuna               String
  
  // Contacto
  contactEmail         String
  contactPhone         String?
  
  // Configuración
  logoUrl              String?
  primaryColor         String?
  secondaryColor       String?
  faviconUrl           String?
  
  // Mapa por defecto
  defaultMapComuna     String
  mapCenterLat         Float?
  mapCenterLng         Float?
  mapZoom              Int       @default(13)
  
  // Features & Limits
  demoDataEnabled      Boolean   @default(false)
  maxUsers             Int       @default(10)
  maxStorageGB         Int       @default(10)
  
  // Metadata
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  suspendedAt          DateTime?
  suspensionReason     String?
  
  // Relaciones
  users                User[]
  budgets              Budget[]
  expenditures         Expenditure[]
  projects             Project[]
  contracts            Contract[]
  fileUploads          FileUpload[]
  mapProjects          MunicipalMapProject[]
  chatbotInteractions  ChatbotInteraction[]
  auditLogs            AuditLog[]

  @@map("tenants")
  @@index([slug])
  @@index([status])
}

// ============================================
// DATA MODELS (Multi-Tenant Aware)
// ============================================

model Budget {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  fiscalYearId  String
  department    String
  program       String
  category      String
  subcategory   String
  amountPlanned Float
  currency      String
  notes         String?
  isPublic      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("budgets")
  @@index([tenantId])
  @@index([tenantId, isPublic])
}

model Expenditure {
  id             String   @id @default(cuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  fiscalYearId   String
  date           DateTime
  department     String
  program        String
  category       String
  subcategory    String
  concept        String
  amountActual   Float
  currency       String
  supplierId     String?
  procurementRef String?
  location       String?
  isPublic       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("expenditures")
  @@index([tenantId])
  @@index([tenantId, isPublic])
}

model Project {
  id              String    @id @default(cuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title           String
  description     String
  status          String
  startDate       DateTime?
  endDate         DateTime?
  department      String
  category        String
  requestedBudget Float?
  approvedBudget  Float?
  fundingSourceId String?
  location        String?
  isPublic        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("projects")
  @@index([tenantId])
  @@index([tenantId, isPublic])
}

model Contract {
  id             String    @id @default(cuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  supplierId     String
  title          String
  description    String
  amount         Float
  currency       String
  startDate      DateTime
  endDate        DateTime?
  status         String
  contractNumber String?
  isPublic       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("contracts")
  @@index([tenantId])
  @@index([tenantId, isPublic])
}

model User {
  id           String    @id @default(cuid())
  tenantId     String?   // Null para SUPER_ADMIN
  tenant       Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  email        String    @unique
  passwordHash String
  role         String    @default("lector") // super_admin, municipal_admin, editor, lector
  firstName    String?
  lastName     String?
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("users")
  @@index([tenantId])
  @@index([email])
  @@index([role])
}

model FileUpload {
  id                 String   @id @default(cuid())
  tenantId           String
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  originalName       String
  fileName           String
  mimeType           String
  size               Int
  cloud_storage_path String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("file_uploads")
  @@index([tenantId])
}

model MunicipalMapProject {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  description String
  category    String
  latitude    Float
  longitude   Float
  progress    Int      @default(0)
  amount      Float    @default(0)
  isActive    Boolean  @default(true)
  comuna      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("municipal_map_projects")
  @@index([tenantId])
  @@index([tenantId, isActive])
}

model ChatbotInteraction {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userMessage   String
  botResponse   String   @db.Text
  intent        String?
  category      String?
  hasData       Boolean  @default(true)
  filters       Json?
  sessionId     String?
  userAgent     String?
  timestamp     DateTime @default(now())
  responseTime  Int?
  
  @@map("chatbot_interactions")
  @@index([tenantId])
  @@index([tenantId, timestamp])
  @@index([category])
  @@index([intent])
}

// ============================================
// AUDIT LOG (Compliance & Security)
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  actor       String   // Email del usuario que realizó la acción
  actorRole   String   // Rol del actor en el momento de la acción
  action      String   // CREATE_TENANT, SUSPEND_TENANT, DELETE_PROJECT, etc.
  resource    String   // Tipo de recurso: tenant, project, user, etc.
  resourceId  String?  // ID del recurso afectado
  
  metadata    Json?    // Payload adicional (cambios, filtros, etc.)
  ipAddress   String?
  userAgent   String?
  
  timestamp   DateTime @default(now())
  
  @@map("audit_logs")
  @@index([tenantId])
  @@index([timestamp])
  @@index([action])
  @@index([actor])
}
