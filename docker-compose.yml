version: '3.9'

services:
  # ====================================
  # PostgreSQL + PostGIS Database
  # ====================================
  postgres:
    image: postgis/postgis:15-3.3-alpine
    container_name: municipal_postgres
    environment:
      POSTGRES_USER: municipal_user
      POSTGRES_PASSWORD: municipal_pass
      POSTGRES_DB: municipal_transparency
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=es_CL.UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Init scripts if needed
      - ./scripts/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
    ports:
      - "5432:5432"
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U municipal_user -d municipal_transparency"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ====================================
  # Redis Cache & Session Store
  # ====================================
  redis:
    image: redis:7-alpine
    container_name: municipal_redis
    command: redis-server --appendonly yes --requirepass redis_pass
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ====================================
  # NestJS API Backend
  # ====================================
  api:
    build:
      context: .
      dockerfile: ./apps/api/Dockerfile
      target: runner
    container_name: municipal_api
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Database
      DATABASE_URL: postgresql://municipal_user:municipal_pass@postgres:5432/municipal_transparency
      
      # Redis
      REDIS_URL: redis://:redis_pass@redis:6379
      
      # JWT Secrets (CHANGE IN PRODUCTION!)
      JWT_SECRET: dev-secret-change-in-production-please-use-strong-secret
      JWT_REFRESH_SECRET: dev-refresh-secret-change-in-production-please-use-strong-secret
      JWT_EXPIRATION: 15m
      JWT_REFRESH_EXPIRATION: 7d
      
      # App Configuration
      NODE_ENV: development
      PORT: 3001
      API_PREFIX: api
      
      # CORS
      CORS_ORIGINS: http://localhost:3000,http://localhost:3002
      
      # Rate Limiting
      THROTTLE_TTL: 60
      THROTTLE_LIMIT: 100
      
      # Logging
      LOG_LEVEL: debug
      
      # Swagger
      SWAGGER_ENABLED: "true"
      SWAGGER_PATH: api/docs
    ports:
      - "3001:3001"
    networks:
      - backend
    volumes:
      # Mount for hot reload in development (optional)
      - ./apps/api/src:/app/apps/api/src:ro
      # Logs
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ====================================
# Volumes
# ====================================
volumes:
  postgres_data:
    driver: local
    name: municipal_postgres_data
  redis_data:
    driver: local
    name: municipal_redis_data

# ====================================
# Networks
# ====================================
networks:
  backend:
    driver: bridge
    name: municipal_network
